## 什么是配置版本
网关所有影响流量、路由行为的配置，均属于配置版本范畴内。您需要通过发布新配置版本来更新现有的流量、路由及其他相关配置。
发布版本过程中，支持灰度能力，您可以先切换较少的流量验证新版本配置，然后再切换更多流量，直到全量发布。

## 创建网关版本
在网关详情页内，单击**新建版本**，在版本中可填写版本描述并配置路由及其他相关内容。
![](https://qcloudimg.tencent-cloud.cn/raw/7752c72e3176e06d38ab9a3cb8fc2126.png)
如果有存量版本，也可以通过存量版本的"复制"能力来创建新版本，复制后可以进一步修改配置，实现版本的快速创建或调整。
![](https://qcloudimg.tencent-cloud.cn/raw/18943f0e28c67b2d724bb6c4d122f98c.png)

### 路由配置

一个版本可以有多个路由，单击**新建路由**即可创建。
路由配置分为七层路由或四层路由：
- 七层路由填写内容包括：
    - 协议：HTTP 或 HTTPS ，网关将以对应的协议转发请求，推荐使用 HTTP。
    - 域名：网关通过对应域名来匹配路由规则，以及转发请求。
    - 路径：默认为 "/"，网关通过请求路径来匹配路由规则。
    - 方法：默认为 "ALL"，可以通过调整请求方法，将不同请求方法路由到不同后端。
    - 后端服务类型：网关支持路由到不同的后端服务上。
    - 后端服务 IP：网关会将匹配到的请求转发请求到后端服务IP；服务 IP 可以保留为空，如果不填写，网关将会尝试解析域名并转发至地址上。
- 四层路由填写内容包括：
    - 域名：四层域名需要通过网关的公网接入配置创建四层接入域名。
    - 端口：使用的通讯端口需要通过网关的公网接入配置创建四层接入端口。
    - 后端服务 IP：网关会将对应域名及端口的连接及数据包，转发至指定的后端服务 IP。

>? 如果域名或 IP 需要通过公网访问，请先在网关所在的 VPC 网络内配置 NAT 网关。

![](https://qcloudimg.tencent-cloud.cn/raw/dcc896190fd71a35f8b362dcc3e8e85f.png)


### 日志配置
通过选择**投递到 CLS**，可以配置将网关上的网络请求及响应均投递至日志服务中。日志投递跟随当前配置版本的生效情况而生效。
选择投递到日志服务 CLS 时，需要指定投递的日志主题。同时可以根据情况，选择投递内容，除基础字段默认投递外，可以选择投递请求 header，请求 body，响应 header，响应 body。
>? 非必要的情况下建议不要投递 body 内容，可能会产生比较大的日志流量、存储情况。同时 header 限制最大 10KB，body 限制最大 50KB。超过部分将不会投递至日志服务。

![](https://qcloudimg.tencent-cloud.cn/raw/db4196095b83d15b5610b43fcc849cec.png)

### 高级配置
网关配置版本支持相关高级配置：
- 地域黑白名单：支持配置地域黑名单或白名单，地域当前仅区分国内、国外地域。
- IP 黑白名单：支持 IP 地址黑名单或白名单，支持填写多个 IP 或 CIDR 地址段。
- 启用 X-Real-IP：开启后，客户端 IP 地址除使用  X-Forward-For  传递外，也同时使用  X-Real-IP 传递客户端源 IP 地址。
- HTTP1.0 支持：开启后，支持客户端使用  http1.0  协议通讯。


## 版本流量配置、灰度发布
配置完成后，完成创建版本，路由配置将被固化到版本，一个网关可以创建三个版本。
通过**流量配置**，可以随时进行版本流量控制和调整。当前支持按百分比将流量分配至不同版本。 
通过逐步调整不同版本间的流量，可以实现配置版本的灰度发布生效。

![](https://qcloudimg.tencent-cloud.cn/raw/07b40a4fb8cd2c59eb842d2cdc594e15.png)
